name: CI Pipeline - Optimized for 2000 min/month

on:
  push:
    branches: [ main, develop, 'claude/**' ]
    paths-ignore:
      - '**.md'
      - 'docs/**'
      - '.gitignore'
      - 'LICENSE'
  pull_request:
    branches: [ main, develop ]
    paths-ignore:
      - '**.md'
      - 'docs/**'
      - '.gitignore'
      - 'LICENSE'
  workflow_dispatch:
    inputs:
      run_all_tests:
        description: 'Run all tests including SAST and SonarQube'
        required: false
        default: 'false'
        type: boolean
      run_docker_build:
        description: 'Build and push Docker images'
        required: false
        default: 'false'
        type: boolean

env:
  JAVA_VERSION: '17'
  NODE_VERSION: '18'
  SONAR_HOST_URL: https://sonarcloud.io
  # Docker Hub registry configuration
  DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
  REGISTRY: docker.io

# Cancel in-progress runs for the same branch
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # ============================================================================
  # JOB 0: Detect which services changed (SAVES MASSIVE MINUTES!)
  # ============================================================================
  changes:
    name: Detect Changes
    runs-on: ubuntu-latest
    timeout-minutes: 2
    outputs:
      backend: ${{ steps.filter.outputs.backend }}
      backend_services: ${{ steps.filter.outputs.backend_services }}
      frontend: ${{ steps.filter.outputs.frontend }}
      infrastructure: ${{ steps.filter.outputs.infrastructure }}
      auth-service: ${{ steps.filter.outputs.auth-service }}
      patient-service: ${{ steps.filter.outputs.patient-service }}
      appointment-service: ${{ steps.filter.outputs.appointment-service }}
      dental-records-service: ${{ steps.filter.outputs.dental-records-service }}
      xray-service: ${{ steps.filter.outputs.xray-service }}
      treatment-service: ${{ steps.filter.outputs.treatment-service }}
      notification-service: ${{ steps.filter.outputs.notification-service }}
      api-gateway: ${{ steps.filter.outputs.api-gateway }}
      eureka-server: ${{ steps.filter.outputs.eureka-server }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Detect file changes
        uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            backend:
              - 'microservices/**'
            frontend:
              - 'ReactDentalHelp/**'
            infrastructure:
              - 'docker-compose*.yml'
              - 'deployment/**'
              - '.github/workflows/**'
            auth-service:
              - 'microservices/auth-service/**'
            patient-service:
              - 'microservices/patient-service/**'
            appointment-service:
              - 'microservices/appointment-service/**'
            dental-records-service:
              - 'microservices/dental-records-service/**'
            xray-service:
              - 'microservices/xray-service/**'
            treatment-service:
              - 'microservices/treatment-service/**'
            notification-service:
              - 'microservices/notification-service/**'
            api-gateway:
              - 'microservices/api-gateway/**'
            eureka-server:
              - 'microservices/eureka-server/**'

      - name: List changed services
        run: |
          echo "Backend changed: ${{ steps.filter.outputs.backend }}"
          echo "Frontend changed: ${{ steps.filter.outputs.frontend }}"
          echo "Infrastructure changed: ${{ steps.filter.outputs.infrastructure }}"

  # ============================================================================
  # JOB 1: Build ONLY Changed Backend Services (HUGE SAVINGS!)
  # ============================================================================
  build-backend:
    name: Build - ${{ matrix.service }}
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: changes
    if: needs.changes.outputs.backend == 'true'

    strategy:
      matrix:
        service:
          - auth-service
          - patient-service
          - appointment-service
          - dental-records-service
          - xray-service
          - treatment-service
          - notification-service
          - api-gateway
          - eureka-server
      fail-fast: false

    steps:
      - name: Check if service changed
        id: check
        run: |
          # Map service to change detection output
          case "${{ matrix.service }}" in
            auth-service) CHANGED="${{ needs.changes.outputs.auth-service }}" ;;
            patient-service) CHANGED="${{ needs.changes.outputs.patient-service }}" ;;
            appointment-service) CHANGED="${{ needs.changes.outputs.appointment-service }}" ;;
            dental-records-service) CHANGED="${{ needs.changes.outputs.dental-records-service }}" ;;
            xray-service) CHANGED="${{ needs.changes.outputs.xray-service }}" ;;
            treatment-service) CHANGED="${{ needs.changes.outputs.treatment-service }}" ;;
            notification-service) CHANGED="${{ needs.changes.outputs.notification-service }}" ;;
            api-gateway) CHANGED="${{ needs.changes.outputs.api-gateway }}" ;;
            eureka-server) CHANGED="${{ needs.changes.outputs.eureka-server }}" ;;
            *) CHANGED="false" ;;
          esac
          echo "changed=${CHANGED}" >> $GITHUB_OUTPUT
          echo "Service ${{ matrix.service }} changed: ${CHANGED}"

      - name: Checkout code
        if: steps.check.outputs.changed == 'true'
        uses: actions/checkout@v4

      - name: Set up JDK ${{ env.JAVA_VERSION }}
        if: steps.check.outputs.changed == 'true'
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'
          cache: 'maven'

      - name: Build and test ${{ matrix.service }}
        if: steps.check.outputs.changed == 'true'
        run: |
          cd microservices/${{ matrix.service }}
          mvn clean package -B -q
          echo "Build successful for ${{ matrix.service }}"

      - name: Upload JAR artifact
        if: steps.check.outputs.changed == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: jar-${{ matrix.service }}
          path: microservices/${{ matrix.service }}/target/*.jar
          retention-days: 1
          if-no-files-found: error

      - name: Skip message
        if: steps.check.outputs.changed != 'true'
        run: echo "Skipping ${{ matrix.service }} - no changes detected"

  # ============================================================================
  # JOB 2: Build Frontend (Only if changed)
  # ============================================================================
  build-frontend:
    name: Build Frontend
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: changes
    if: needs.changes.outputs.frontend == 'true'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js ${{ env.NODE_VERSION }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: ReactDentalHelp/package-lock.json

      - name: Install and build
        run: |
          cd ReactDentalHelp
          npm ci --legacy-peer-deps
          npm run lint || true
          npm run build

      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: frontend-build
          path: ReactDentalHelp/dist/
          retention-days: 1

  # ============================================================================
  # JOB 3: Quick Security Scan (Only on main/develop or manual trigger)
  # Saves ~15 min per feature branch push!
  # ============================================================================
  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: [changes, build-backend]
    if: |
      always() &&
      (needs.build-backend.result == 'success' || needs.build-backend.result == 'skipped') &&
      (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop' || github.event.inputs.run_all_tests == 'true')

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'table'
          severity: 'CRITICAL,HIGH'
          exit-code: '0'

      - name: Semgrep SAST Scan
        uses: returntocorp/semgrep-action@v1
        with:
          config: p/security-audit
        continue-on-error: true

  # ============================================================================
  # JOB 4: SonarQube (Only on main/develop - SAVES ~20 min per feature branch!)
  # ============================================================================
  sonarqube:
    name: Code Quality Analysis
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: [changes, build-backend]
    if: |
      always() &&
      (needs.build-backend.result == 'success' || needs.build-backend.result == 'skipped') &&
      (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop' || github.event.inputs.run_all_tests == 'true')

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up JDK ${{ env.JAVA_VERSION }}
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'
          cache: 'maven'

      - name: Cache SonarCloud packages
        uses: actions/cache@v4
        with:
          path: ~/.sonar/cache
          key: ${{ runner.os }}-sonar
          restore-keys: ${{ runner.os }}-sonar

      - name: Run SonarQube Analysis
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        run: |
          if [ -z "$SONAR_TOKEN" ]; then
            echo "SONAR_TOKEN not set - skipping SonarQube analysis"
            exit 0
          fi

          # Only analyze changed services to save time
          for service in auth-service patient-service appointment-service dental-records-service xray-service treatment-service notification-service api-gateway eureka-server; do
            echo "Analyzing $service..."
            cd microservices/$service
            mvn clean verify sonar:sonar \
              -DskipTests \
              -Dsonar.projectKey=${{ secrets.SONAR_PROJECT_KEY }}-$service \
              -Dsonar.organization=${{ secrets.SONAR_ORGANIZATION }} \
              -Dsonar.host.url=https://sonarcloud.io \
              -B -q || echo "SonarQube failed for $service"
            cd ../..
          done
        continue-on-error: true

  # ============================================================================
  # JOB 5: Integration Tests (Only on main/develop)
  # ============================================================================
  integration-tests:
    name: Integration Tests
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: [changes, build-backend]
    if: |
      always() &&
      (needs.build-backend.result == 'success' || needs.build-backend.result == 'skipped') &&
      (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop')

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Create .env file
        run: |
          cat > .env << EOF
          MAIL_USERNAME=test@example.com
          MAIL_PASSWORD=testpassword
          AZURE_STORAGE_CONNECTION_STRING=DefaultEndpointsProtocol=https;AccountName=devstoreaccount1;AccountKey=test;
          AZURE_STORAGE_CONTAINER_NAME=xrays
          EOF

      - name: Start infrastructure
        run: |
          docker-compose up -d rabbitmq eureka-server
          sleep 20

      - name: Health checks
        run: |
          echo "Checking RabbitMQ..."
          timeout 60 bash -c 'until curl -sf http://localhost:15672 > /dev/null; do sleep 2; done' || echo "RabbitMQ timeout"

          echo "Checking Eureka..."
          timeout 60 bash -c 'until curl -sf http://localhost:8761/actuator/health > /dev/null; do sleep 2; done' || echo "Eureka timeout"
        continue-on-error: true

      - name: Cleanup
        if: always()
        run: docker-compose down -v || true

  # ============================================================================
  # JOB 6: Build Docker Images (Only on main/develop, REUSES JAR ARTIFACTS!)
  # ============================================================================
  docker-build:
    name: Docker - ${{ matrix.service }}
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: [changes, build-backend, security-scan]
    if: |
      always() &&
      needs.build-backend.result == 'success' &&
      (github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop')) ||
      github.event.inputs.run_docker_build == 'true'

    strategy:
      matrix:
        service:
          - auth-service
          - patient-service
          - appointment-service
          - dental-records-service
          - xray-service
          - treatment-service
          - notification-service
          - api-gateway
          - eureka-server
      fail-fast: false

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download JAR artifact
        uses: actions/download-artifact@v4
        with:
          name: jar-${{ matrix.service }}
          path: microservices/${{ matrix.service }}/target/
        continue-on-error: true

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ secrets.DOCKERHUB_USERNAME }}/dentalhelp-${{ matrix.service }}
          tags: |
            type=ref,event=branch
            type=sha,prefix={{branch}}-
            type=raw,value=latest,enable={{is_default_branch}}

      - name: Check for pre-built JAR
        id: jar-check
        run: |
          if ls microservices/${{ matrix.service }}/target/*.jar 1>/dev/null 2>&1; then
            echo "has_jar=true" >> $GITHUB_OUTPUT
            echo "Found pre-built JAR, using optimized build"
          else
            echo "has_jar=false" >> $GITHUB_OUTPUT
            echo "No pre-built JAR, will use full Maven build"
          fi

      # Use optimized CI Dockerfile if we have pre-built JAR (saves ~5 min per image)
      - name: Build and push Docker image (optimized)
        if: steps.jar-check.outputs.has_jar == 'true'
        uses: docker/build-push-action@v5
        with:
          context: .
          file: Dockerfile.ci
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          build-args: |
            SERVICE=${{ matrix.service }}
            BUILD_DATE=${{ github.event.head_commit.timestamp }}
            VCS_REF=${{ github.sha }}

      # Fallback to standard Dockerfile if no pre-built JAR
      - name: Build and push Docker image (fallback)
        if: steps.jar-check.outputs.has_jar != 'true'
        uses: docker/build-push-action@v5
        with:
          context: ./microservices/${{ matrix.service }}
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          build-args: |
            BUILD_DATE=${{ github.event.head_commit.timestamp }}
            VCS_REF=${{ github.sha }}

  # ============================================================================
  # FINAL: CI Summary
  # ============================================================================
  ci-summary:
    name: CI Summary
    runs-on: ubuntu-latest
    timeout-minutes: 2
    needs: [changes, build-backend, build-frontend, security-scan, integration-tests]
    if: always()

    steps:
      - name: Generate Summary
        run: |
          echo "### CI Pipeline Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Changes Detection | ${{ needs.changes.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Backend Build | ${{ needs.build-backend.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Frontend Build | ${{ needs.build-frontend.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Security Scan | ${{ needs.security-scan.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Integration Tests | ${{ needs.integration-tests.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "_Optimized for 2000 min/month budget_" >> $GITHUB_STEP_SUMMARY

      - name: Check core builds
        run: |
          BACKEND="${{ needs.build-backend.result }}"
          FRONTEND="${{ needs.build-frontend.result }}"

          # Success if builds passed OR were skipped (no changes)
          if [[ "$BACKEND" == "success" || "$BACKEND" == "skipped" ]] && \
             [[ "$FRONTEND" == "success" || "$FRONTEND" == "skipped" ]]; then
            echo "CI passed!"
            exit 0
          else
            echo "CI failed"
            exit 1
          fi
