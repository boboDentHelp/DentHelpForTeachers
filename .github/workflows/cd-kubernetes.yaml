name: CD - Deploy to Kubernetes

on:
  workflow_run:
    workflows: ["CI Pipeline - Optimized for 2000 min/month"]
    types: [completed]
    branches: [main]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'staging'
        type: choice
        options:
          - staging
          - production
      services:
        description: 'Services to deploy (comma-separated, or "all")'
        required: false
        default: 'all'

env:
  DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
  KUBE_CONFIG: ${{ secrets.KUBE_CONFIG }}

jobs:
  # ============================================================================
  # JOB 1: Prepare Deployment
  # ============================================================================
  prepare:
    name: Prepare Deployment
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}
    outputs:
      services: ${{ steps.services.outputs.list }}
      image_tag: ${{ steps.tag.outputs.tag }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Determine services to deploy
        id: services
        run: |
          if [ "${{ github.event.inputs.services }}" == "all" ] || [ -z "${{ github.event.inputs.services }}" ]; then
            echo 'list=["eureka-server","api-gateway","auth-service","patient-service","appointment-service","dental-records-service","xray-service","treatment-service","notification-service"]' >> $GITHUB_OUTPUT
          else
            # Convert comma-separated to JSON array
            SERVICES=$(echo "${{ github.event.inputs.services }}" | sed 's/,/","/g' | sed 's/^/["/' | sed 's/$/"]/')
            echo "list=${SERVICES}" >> $GITHUB_OUTPUT
          fi

      - name: Determine image tag
        id: tag
        run: |
          if [ "${{ github.event.inputs.environment }}" == "production" ]; then
            echo "tag=latest" >> $GITHUB_OUTPUT
          else
            echo "tag=main-${{ github.sha }}" >> $GITHUB_OUTPUT
          fi

  # ============================================================================
  # JOB 2: Deploy Infrastructure
  # ============================================================================
  deploy-infrastructure:
    name: Deploy Infrastructure
    runs-on: ubuntu-latest
    needs: prepare
    environment: ${{ github.event.inputs.environment || 'staging' }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup kubectl
        uses: azure/setup-kubectl@v3
        with:
          version: 'v1.28.0'

      - name: Configure kubectl
        run: |
          mkdir -p ~/.kube
          echo "${{ secrets.KUBE_CONFIG }}" | base64 -d > ~/.kube/config
          chmod 600 ~/.kube/config

      - name: Deploy namespace and configs
        run: |
          kubectl apply -f deployment/kubernetes/00-namespace.yaml
          kubectl apply -f deployment/kubernetes/01-secrets.yaml
          kubectl apply -f deployment/kubernetes/02-configmap.yaml
          kubectl apply -f deployment/kubernetes/03-storage.yaml

      - name: Deploy infrastructure services
        run: |
          kubectl apply -f deployment/kubernetes/10-rabbitmq.yaml
          kubectl apply -f deployment/kubernetes/11-redis.yaml
          kubectl apply -f deployment/kubernetes/12-mysql.yaml

      - name: Wait for infrastructure
        run: |
          echo "Waiting for RabbitMQ..."
          kubectl wait --for=condition=ready pod -l app=rabbitmq -n dentalhelp --timeout=120s || true

          echo "Waiting for Redis..."
          kubectl wait --for=condition=ready pod -l app=redis -n dentalhelp --timeout=60s || true

          echo "Waiting for MySQL databases..."
          for db in auth patient appointment dental-records xray treatment notification; do
            kubectl wait --for=condition=ready pod -l app=mysql-$db -n dentalhelp --timeout=120s || echo "mysql-$db not ready yet"
          done

  # ============================================================================
  # JOB 3: Deploy Microservices
  # ============================================================================
  deploy-services:
    name: Deploy - ${{ matrix.service }}
    runs-on: ubuntu-latest
    needs: [prepare, deploy-infrastructure]
    environment: ${{ github.event.inputs.environment || 'staging' }}

    strategy:
      matrix:
        service: ${{ fromJson(needs.prepare.outputs.services) }}
      fail-fast: false
      max-parallel: 3

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup kubectl
        uses: azure/setup-kubectl@v3
        with:
          version: 'v1.28.0'

      - name: Configure kubectl
        run: |
          mkdir -p ~/.kube
          echo "${{ secrets.KUBE_CONFIG }}" | base64 -d > ~/.kube/config
          chmod 600 ~/.kube/config

      - name: Update image tag in deployment
        run: |
          IMAGE="${{ env.DOCKERHUB_USERNAME }}/dentalhelp-${{ matrix.service }}:${{ needs.prepare.outputs.image_tag }}"
          echo "Deploying image: $IMAGE"

          # Update image in deployment files
          if [ "${{ matrix.service }}" == "eureka-server" ]; then
            sed -i "s|\${DOCKERHUB_USERNAME}/dentalhelp-eureka-server:latest|$IMAGE|g" deployment/kubernetes/20-eureka-server.yaml
            kubectl apply -f deployment/kubernetes/20-eureka-server.yaml
          elif [ "${{ matrix.service }}" == "api-gateway" ]; then
            sed -i "s|\${DOCKERHUB_USERNAME}/dentalhelp-api-gateway:latest|$IMAGE|g" deployment/kubernetes/21-api-gateway.yaml
            kubectl apply -f deployment/kubernetes/21-api-gateway.yaml
          else
            sed -i "s|\${DOCKERHUB_USERNAME}/dentalhelp-${{ matrix.service }}:latest|$IMAGE|g" deployment/kubernetes/22-microservices.yaml
            kubectl apply -f deployment/kubernetes/22-microservices.yaml
          fi

      - name: Wait for rollout
        run: |
          kubectl rollout status deployment/${{ matrix.service }} -n dentalhelp --timeout=180s

      - name: Verify deployment
        run: |
          kubectl get pods -l app=${{ matrix.service }} -n dentalhelp
          kubectl get svc ${{ matrix.service }} -n dentalhelp

  # ============================================================================
  # JOB 4: Deploy Ingress
  # ============================================================================
  deploy-ingress:
    name: Deploy Ingress
    runs-on: ubuntu-latest
    needs: deploy-services
    environment: ${{ github.event.inputs.environment || 'staging' }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup kubectl
        uses: azure/setup-kubectl@v3
        with:
          version: 'v1.28.0'

      - name: Configure kubectl
        run: |
          mkdir -p ~/.kube
          echo "${{ secrets.KUBE_CONFIG }}" | base64 -d > ~/.kube/config
          chmod 600 ~/.kube/config

      - name: Deploy ingress
        run: |
          kubectl apply -f deployment/kubernetes/30-ingress.yaml

  # ============================================================================
  # JOB 5: Smoke Tests
  # ============================================================================
  smoke-tests:
    name: Smoke Tests
    runs-on: ubuntu-latest
    needs: deploy-services
    environment: ${{ github.event.inputs.environment || 'staging' }}

    steps:
      - name: Setup kubectl
        uses: azure/setup-kubectl@v3
        with:
          version: 'v1.28.0'

      - name: Configure kubectl
        run: |
          mkdir -p ~/.kube
          echo "${{ secrets.KUBE_CONFIG }}" | base64 -d > ~/.kube/config
          chmod 600 ~/.kube/config

      - name: Get API Gateway URL
        id: gateway
        run: |
          # Get LoadBalancer IP or hostname
          GATEWAY_IP=$(kubectl get svc api-gateway -n dentalhelp -o jsonpath='{.status.loadBalancer.ingress[0].ip}' 2>/dev/null || \
                       kubectl get svc api-gateway -n dentalhelp -o jsonpath='{.status.loadBalancer.ingress[0].hostname}' 2>/dev/null || \
                       echo "")

          if [ -z "$GATEWAY_IP" ]; then
            # Use port-forward for testing
            kubectl port-forward svc/api-gateway 8080:8080 -n dentalhelp &
            sleep 5
            GATEWAY_IP="localhost:8080"
          fi
          echo "url=http://$GATEWAY_IP" >> $GITHUB_OUTPUT

      - name: Test API Gateway health
        run: |
          curl -sf "${{ steps.gateway.outputs.url }}/actuator/health" || echo "Gateway health check failed"

      - name: Test Eureka registration
        run: |
          # Check if services are registered in Eureka
          kubectl exec -it $(kubectl get pod -l app=eureka-server -n dentalhelp -o jsonpath='{.items[0].metadata.name}') -n dentalhelp -- \
            curl -s http://localhost:8761/eureka/apps | grep -c "UP" || echo "Eureka check completed"

      - name: Generate deployment summary
        run: |
          echo "### Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Service | Status | Replicas |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|--------|----------|" >> $GITHUB_STEP_SUMMARY

          for svc in eureka-server api-gateway auth-service patient-service appointment-service dental-records-service xray-service treatment-service notification-service; do
            REPLICAS=$(kubectl get deployment $svc -n dentalhelp -o jsonpath='{.status.readyReplicas}/{.spec.replicas}' 2>/dev/null || echo "N/A")
            STATUS=$(kubectl get deployment $svc -n dentalhelp -o jsonpath='{.status.conditions[?(@.type=="Available")].status}' 2>/dev/null || echo "Unknown")
            echo "| $svc | $STATUS | $REPLICAS |" >> $GITHUB_STEP_SUMMARY
          done

  # ============================================================================
  # JOB 6: Rollback (on failure)
  # ============================================================================
  rollback:
    name: Rollback
    runs-on: ubuntu-latest
    needs: [deploy-services, smoke-tests]
    if: failure()
    environment: ${{ github.event.inputs.environment || 'staging' }}

    steps:
      - name: Setup kubectl
        uses: azure/setup-kubectl@v3
        with:
          version: 'v1.28.0'

      - name: Configure kubectl
        run: |
          mkdir -p ~/.kube
          echo "${{ secrets.KUBE_CONFIG }}" | base64 -d > ~/.kube/config
          chmod 600 ~/.kube/config

      - name: Rollback deployments
        run: |
          echo "Rolling back failed deployments..."
          for svc in eureka-server api-gateway auth-service patient-service appointment-service dental-records-service xray-service treatment-service notification-service; do
            kubectl rollout undo deployment/$svc -n dentalhelp || echo "Rollback skipped for $svc"
          done

      - name: Verify rollback
        run: |
          kubectl get deployments -n dentalhelp
          kubectl get pods -n dentalhelp
