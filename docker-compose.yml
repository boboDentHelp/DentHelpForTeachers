services:
  # ==================== DATABASES ====================

  auth-db:
    image: mysql:8.0
    container_name: auth-db
    environment:
      MYSQL_ROOT_PASSWORD: root
      MYSQL_DATABASE: auth_db
    ports:
      - "3307:3306"
    volumes:
      - auth-db-data:/var/lib/mysql
      - ./database-init/auth-db-init.sql:/docker-entrypoint-initdb.d/init.sql:ro
    networks:
      - microservices-network
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost"]
      timeout: 20s
      retries: 10

  patient-db:
    image: mysql:8.0
    container_name: patient-db
    environment:
      MYSQL_ROOT_PASSWORD: root
      MYSQL_DATABASE: patient_db
    ports:
      - "3308:3306"
    volumes:
      - patient-db-data:/var/lib/mysql
      - ./database-init/patient-db-init.sql:/docker-entrypoint-initdb.d/init.sql:ro
    networks:
      - microservices-network
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost"]
      timeout: 20s
      retries: 10

  appointment-db:
    image: mysql:8.0
    container_name: appointment-db
    environment:
      MYSQL_ROOT_PASSWORD: root
      MYSQL_DATABASE: appointment_db
    ports:
      - "3309:3306"
    volumes:
      - appointment-db-data:/var/lib/mysql
    networks:
      - microservices-network
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost"]
      timeout: 20s
      retries: 10

  dental-records-db:
    image: mysql:8.0
    container_name: dental-records-db
    environment:
      MYSQL_ROOT_PASSWORD: root
      MYSQL_DATABASE: dental_records_db
    ports:
      - "3310:3306"
    volumes:
      - dental-records-db-data:/var/lib/mysql
    networks:
      - microservices-network
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost"]
      timeout: 20s
      retries: 10

  xray-db:
    image: mysql:8.0
    container_name: xray-db
    environment:
      MYSQL_ROOT_PASSWORD: root
      MYSQL_DATABASE: xray_db
    ports:
      - "3311:3306"
    volumes:
      - xray-db-data:/var/lib/mysql
    networks:
      - microservices-network
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost"]
      timeout: 20s
      retries: 10

  treatment-db:
    image: mysql:8.0
    container_name: treatment-db
    environment:
      MYSQL_ROOT_PASSWORD: root
      MYSQL_DATABASE: treatment_db
    ports:
      - "3312:3306"
    volumes:
      - treatment-db-data:/var/lib/mysql
    networks:
      - microservices-network
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost"]
      timeout: 20s
      retries: 10

  notification-db:
    image: mysql:8.0
    container_name: notification-db
    environment:
      MYSQL_ROOT_PASSWORD: root
      MYSQL_DATABASE: notification_db
    ports:
      - "3313:3306"
    volumes:
      - notification-db-data:/var/lib/mysql
    networks:
      - microservices-network
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost"]
      timeout: 20s
      retries: 10

  # ==================== DATABASE INITIALIZATION ====================

  db-init:
    image: mysql:8.0
    container_name: db-init
    volumes:
      - ./database-init/init-databases.sh:/init-databases.sh
    networks:
      - microservices-network
    depends_on:
      auth-db:
        condition: service_healthy
      patient-db:
        condition: service_healthy
    command: bash /init-databases.sh
    restart: "no"

  # ==================== MESSAGE BROKER ====================

  rabbitmq:
    image: rabbitmq:3.12-management-alpine
    container_name: rabbitmq
    user: rabbitmq:rabbitmq
    ports:
      - "5672:5672"   # AMQP port
      - "15672:15672" # Management UI
    environment:
      RABBITMQ_DEFAULT_USER: guest
      RABBITMQ_DEFAULT_PASS: guest
      RABBITMQ_ERLANG_COOKIE: "dental-help-secret-cookie"
      RABBITMQ_SERVER_ADDITIONAL_ERL_ARGS: "-rabbitmq_management load_definitions \"/etc/rabbitmq/definitions.json\""
    volumes:
      - rabbitmq-data:/var/lib/rabbitmq
      - ./rabbitmq-init/definitions.json:/etc/rabbitmq/definitions.json:ro
    networks:
      - microservices-network
    healthcheck:
      test: rabbitmq-diagnostics -q ping
      interval: 10s
      timeout: 10s
      retries: 10
      start_period: 40s

  # ==================== CACHE ====================

  redis:
    image: redis:7-alpine
    container_name: redis
    ports:
      - "6379:6379"
    command: redis-server --maxmemory 256mb --maxmemory-policy allkeys-lru --appendonly yes
    volumes:
      - redis-data:/data
    networks:
      - microservices-network
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s

  # ==================== SERVICE DISCOVERY ====================

  eureka-server:
    build:
      context: ./microservices/eureka-server
      dockerfile: Dockerfile
    container_name: eureka-server
    ports:
      - "8761:8761"
    networks:
      - microservices-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8761/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s

  # ==================== API GATEWAY ====================

  api-gateway:
    build:
      context: ./microservices/api-gateway
      dockerfile: Dockerfile
    container_name: api-gateway
    ports:
      - "8080:8080"
    environment:
      EUREKA_CLIENT_SERVICEURL_DEFAULTZONE: http://eureka-server:8761/eureka/
    depends_on:
      eureka-server:
        condition: service_healthy
    networks:
      - microservices-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s

  # ==================== MICROSERVICES ====================

  auth-service:
    build:
      context: ./microservices/auth-service
      dockerfile: Dockerfile
    container_name: auth-service
    ports:
      - "8081:8081"
    environment:
      DB_HOST: auth-db
      DB_NAME: auth_db
      DB_USERNAME: root
      DB_PASSWORD: root
      RABBITMQ_HOST: rabbitmq
      RABBITMQ_USERNAME: guest
      RABBITMQ_PASSWORD: guest
      REDIS_HOST: redis
      REDIS_PORT: 6379
      EUREKA_CLIENT_SERVICEURL_DEFAULTZONE: http://eureka-server:8761/eureka/
      JWT_SECRET: a3d6f8b1c4e529dd2f8e15f7c79a8a0f6e4d9c90b9e6a7c4bfe2d6f9c5e8b7a2
      MAIL_USERNAME: ${MAIL_USERNAME}
      MAIL_PASSWORD: ${MAIL_PASSWORD}
    depends_on:
      auth-db:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
      redis:
        condition: service_healthy
      eureka-server:
        condition: service_healthy
      db-init:
        condition: service_completed_successfully
    networks:
      - microservices-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8081/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s

  patient-service:
    build:
      context: ./microservices/patient-service
      dockerfile: Dockerfile
    container_name: patient-service
    ports:
      - "8082:8082"
    environment:
      DB_HOST: patient-db
      DB_NAME: patient_db
      DB_USERNAME: root
      DB_PASSWORD: root
      RABBITMQ_HOST: rabbitmq
      RABBITMQ_USERNAME: guest
      RABBITMQ_PASSWORD: guest
      EUREKA_CLIENT_SERVICEURL_DEFAULTZONE: http://eureka-server:8761/eureka/
    depends_on:
      patient-db:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
      eureka-server:
        condition: service_healthy
      db-init:
        condition: service_completed_successfully
    networks:
      - microservices-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8082/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s

  appointment-service:
    build:
      context: ./microservices/appointment-service
      dockerfile: Dockerfile
    container_name: appointment-service
    ports:
      - "8083:8083"
    environment:
      DB_HOST: appointment-db
      DB_NAME: appointment_db
      DB_USERNAME: root
      DB_PASSWORD: root
      RABBITMQ_HOST: rabbitmq
      RABBITMQ_USERNAME: guest
      RABBITMQ_PASSWORD: guest
      EUREKA_CLIENT_SERVICEURL_DEFAULTZONE: http://eureka-server:8761/eureka/
    depends_on:
      appointment-db:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
      eureka-server:
        condition: service_healthy
    networks:
      - microservices-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8083/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s

  dental-records-service:
    build:
      context: ./microservices/dental-records-service
      dockerfile: Dockerfile
    container_name: dental-records-service
    ports:
      - "8084:8084"
    environment:
      DB_HOST: dental-records-db
      DB_NAME: dental_records_db
      DB_USERNAME: root
      DB_PASSWORD: root
      RABBITMQ_HOST: rabbitmq
      RABBITMQ_USERNAME: guest
      RABBITMQ_PASSWORD: guest
      EUREKA_CLIENT_SERVICEURL_DEFAULTZONE: http://eureka-server:8761/eureka/
    depends_on:
      dental-records-db:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
      eureka-server:
        condition: service_healthy
    networks:
      - microservices-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8084/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s

  xray-service:
    build:
      context: ./microservices/xray-service
      dockerfile: Dockerfile
    container_name: xray-service
    ports:
      - "8085:8085"
    environment:
      DB_HOST: xray-db
      DB_NAME: xray_db
      DB_USERNAME: root
      DB_PASSWORD: root
      RABBITMQ_HOST: rabbitmq
      RABBITMQ_USERNAME: guest
      RABBITMQ_PASSWORD: guest
      EUREKA_CLIENT_SERVICEURL_DEFAULTZONE: http://eureka-server:8761/eureka/
      AZURE_STORAGE_CONNECTION_STRING: ${AZURE_STORAGE_CONNECTION_STRING}
      AZURE_STORAGE_CONTAINER_NAME: ${AZURE_STORAGE_CONTAINER_NAME:-xrays}
    depends_on:
      xray-db:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
      eureka-server:
        condition: service_healthy
    networks:
      - microservices-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8085/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s

  treatment-service:
    build:
      context: ./microservices/treatment-service
      dockerfile: Dockerfile
    container_name: treatment-service
    ports:
      - "8088:8088"
    environment:
      DB_HOST: treatment-db
      DB_NAME: treatment_db
      DB_USERNAME: root
      DB_PASSWORD: root
      RABBITMQ_HOST: rabbitmq
      RABBITMQ_USERNAME: guest
      RABBITMQ_PASSWORD: guest
      EUREKA_CLIENT_SERVICEURL_DEFAULTZONE: http://eureka-server:8761/eureka/
    depends_on:
      treatment-db:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
      eureka-server:
        condition: service_healthy
    networks:
      - microservices-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8088/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s

  notification-service:
    build:
      context: ./microservices/notification-service
      dockerfile: Dockerfile
    container_name: notification-service
    ports:
      - "8087:8087"
    environment:
      DB_HOST: notification-db
      DB_NAME: notification_db
      DB_USERNAME: root
      DB_PASSWORD: root
      RABBITMQ_HOST: rabbitmq
      RABBITMQ_USERNAME: guest
      RABBITMQ_PASSWORD: guest
      EUREKA_CLIENT_SERVICEURL_DEFAULTZONE: http://eureka-server:8761/eureka/
      MAIL_USERNAME: ${MAIL_USERNAME}
      MAIL_PASSWORD: ${MAIL_PASSWORD}
    depends_on:
      notification-db:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
      eureka-server:
        condition: service_healthy
    networks:
      - microservices-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8087/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s

# ==================== NETWORKS ====================

networks:
  microservices-network:
    driver: bridge

# ==================== VOLUMES ====================

volumes:
  auth-db-data:
  patient-db-data:
  appointment-db-data:
  dental-records-db-data:
  xray-db-data:
  treatment-db-data:
  notification-db-data:
  rabbitmq-data:
  redis-data:
